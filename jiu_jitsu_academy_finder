#!/usr/bin/env python3
"""
Precision Jiu Jitsu Finder by Zip Code

Focused search with precise zip code targeting and adjustable rating filters.
Perfect for honing in on exactly what you want.

Usage:
    python jiu_jitsu_zipcode.py --zip 92120 --min-rating 4.0 --api-key YOUR_KEY
    python jiu_jitsu_zipcode.py --zip 92101 --min-rating 3.5 --radius 2000
"""

import argparse
import json
import sys
import os
from typing import List, Dict, Optional, Tuple
from dataclasses import dataclass

# Try to import Google Maps (optional)
try:
    import googlemaps
    GOOGLE_AVAILABLE = True
except ImportError:
    GOOGLE_AVAILABLE = False


@dataclass
class JiuJitsuSchool:
    """Data class for jiu jitsu school information"""
    name: str
    address: str
    rating: float
    total_ratings: int
    phone: Optional[str] = None
    website: Optional[str] = None
    price_level: Optional[int] = None
    distance_miles: Optional[float] = None
    place_id: str = ""
    is_open: Optional[bool] = None
    place_types: Optional[List[str]] = None


class ZipCodeJiuJitsuFinder:
    """Precision finder focused on zip code searches with adjustable filters"""
    
    def __init__(self, api_key: str = None):
        self.api_key = api_key
        self.google_client = None
        
        if api_key and GOOGLE_AVAILABLE:
            try:
                self.google_client = googlemaps.Client(key=api_key)
                print("üéØ Google Places API ready for precision search")
            except Exception as e:
                print(f"‚ö†Ô∏è Google API setup failed: {e}")
                print("üîÑ Will use fallback search methods")
        
        # Zip code to high-quality schools mapping (fallback data)
        self.zipcode_schools = {
            # San Diego zip codes
            "92101": [  # Downtown San Diego
                {"name": "Victory MMA & Fitness", "rating": 4.7, "address": "3292 Sports Arena Blvd, San Diego, CA", "phone": "(619) 528-0802"},
                {"name": "10th Planet Jiu Jitsu San Diego", "rating": 4.6, "address": "4717 Clairemont Dr, San Diego, CA", "phone": "(858) 270-4717"}
            ],
            "92120": [  # La Mesa/Allied Gardens
                {"name": "Rolles Gracie Jiu Jitsu Academy", "rating": 4.8, "address": "6180 Fairmount Ave, San Diego, CA 92120", "phone": "(619) 265-8430"},
                {"name": "Fabio Santos Brazilian Jiu Jitsu", "rating": 4.9, "address": "7030 Engineer Rd, San Diego, CA 92111", "phone": "(858) 277-7644"}
            ],
            "92126": [  # Mira Mesa
                {"name": "Arena Jiu Jitsu", "rating": 4.8, "address": "9405 Activity Rd, San Diego, CA 92126", "phone": "(858) 586-8865"},
                {"name": "University of Jiu Jitsu", "rating": 4.8, "address": "9888 Carroll Canyon Rd, San Diego, CA 92131", "phone": "(858) 566-4500"}
            ],
            "92130": [  # Carmel Valley
                {"name": "Gracie Jiu Jitsu Carmel Valley", "rating": 4.9, "address": "12650 Carmel Country Rd, San Diego, CA 92130", "phone": "(858) 509-0095"}
            ],
            "92109": [  # Pacific Beach
                {"name": "Pacific Beach Jiu Jitsu", "rating": 4.6, "address": "1880 Garnet Ave, San Diego, CA 92109", "phone": "(858) 483-4000"}
            ],
            "92117": [  # Clairemont
                {"name": "Clairemont BJJ", "rating": 4.7, "address": "4644 Clairemont Dr, San Diego, CA 92117", "phone": "(858) 274-5425"}
            ],
            # Austin zip codes
            "78701": [  # Downtown Austin
                {"name": "Del Mar Jiu Jitsu Club", "rating": 4.8, "address": "1003 Justin Ln, Austin, TX 78757", "phone": "(512) 454-7535"}
            ],
            "78728": [  # North Austin
                {"name": "Paragon Brazilian Jiu Jitsu", "rating": 4.9, "address": "1917 Wells Branch Pkwy, Austin, TX 78728", "phone": "(512) 251-9090"}
            ],
            # Los Angeles zip codes
            "90210": [  # Beverly Hills
                {"name": "Gracie Academy Headquarters", "rating": 4.8, "address": "223 S Central Ave, Torrance, CA 90501", "phone": "(310) 543-7700"}
            ],
            "10001": [  # NYC
                {"name": "Renzo Gracie Academy", "rating": 4.8, "address": "224 W 30th St, New York, NY 10001", "phone": "(212) 279-6724"},
                {"name": "Marcelo Garcia Academy", "rating": 4.9, "address": "250 W 26th St, New York, NY 10001", "phone": "(646) 580-8983"}
            ]
        }
    
    def search_by_zipcode(self, zipcode: str, min_rating: float = 3.0, max_rating: float = 5.0, 
                         radius: int = 3000, limit: int = 15) -> List[JiuJitsuSchool]:
        """
        Precision search by zip code with adjustable filters
        
        Args:
            zipcode: ZIP code to search in
            min_rating: Minimum rating threshold
            max_rating: Maximum rating threshold  
            radius: Search radius in meters
            limit: Maximum number of results
            
        Returns:
            List of JiuJitsuSchool objects matching criteria
        """
        print(f"üéØ Precision search in ZIP {zipcode}")
        print(f"   üìä Rating range: {min_rating} - {max_rating} stars")
        print(f"   üìè Radius: {radius}m ({radius * 0.000621371:.1f} miles)")
        
        schools = []
        
        # Try Google API first
        if self.google_client:
            try:
                print("üîç Searching with Google Places API...")
                schools = self._search_google_by_zipcode(zipcode, min_rating, max_rating, radius)
                if schools:
                    print(f"‚úÖ Google found {len(schools)} schools")
                    # Filter and sort
                    schools = self._filter_and_sort_schools(schools, min_rating, max_rating, limit)
                    return schools
            except Exception as e:
                print(f"‚ö†Ô∏è Google API failed: {str(e)[:50]}...")
                print("üîÑ Falling back to curated data...")
        
        # Fallback to curated data
        schools = self._search_fallback_by_zipcode(zipcode, min_rating, max_rating)
        schools = self._filter_and_sort_schools(schools, min_rating, max_rating, limit)
        
        if schools:
            print(f"‚úÖ Found {len(schools)} schools in curated database")
        else:
            print(f"üí° No schools found for ZIP {zipcode}")
            nearby_zips = self._suggest_nearby_zipcodes(zipcode)
            if nearby_zips:
                print(f"   Try nearby ZIP codes: {', '.join(nearby_zips)}")
        
        return schools
    
    def _search_google_by_zipcode(self, zipcode: str, min_rating: float, max_rating: float, radius: int) -> List[JiuJitsuSchool]:
        """Search using Google Places API with zip code precision"""
        # Get coordinates for zip code
        geocode_result = self.google_client.geocode(zipcode)
        if not geocode_result:
            raise ValueError(f"Could not geocode ZIP code: {zipcode}")
            
        location = geocode_result[0]['geometry']['location']
        lat, lng = location['lat'], location['lng']
        formatted_address = geocode_result[0]['formatted_address']
        print(f"   üìç Coordinates: {lat:.4f}, {lng:.4f} ({formatted_address})")
        
        all_schools = []
        seen_place_ids = set()
        
        # Focused search terms for precision
        search_strategies = [
            ("jiu jitsu", ["gym", "health"]),
            ("brazilian jiu jitsu", ["gym", "health"]),
            ("BJJ", ["gym", "health"]), 
            ("martial arts", ["gym", "health"]),
            ("gracie jiu jitsu", ["gym", "health"])
        ]
        
        for keyword, place_types in search_strategies:
            for place_type in place_types:
                try:
                    print(f"      üîé Searching: {keyword} ({place_type})")
                    
                    # Nearby search with specific type
                    places_result = self.google_client.places_nearby(
                        location=(lat, lng),
                        radius=radius,
                        keyword=keyword,
                        type=place_type
                    )
                    
                    for place in places_result.get('results', []):
                        place_id = place.get('place_id')
                        if place_id in seen_place_ids:
                            continue
                        seen_place_ids.add(place_id)
                        
                        # Initial rating filter
                        rating = place.get('rating', 0)
                        if not (min_rating <= rating <= max_rating):
                            continue
                        
                        # Extract detailed info
                        school = self._extract_detailed_school_info(place, lat, lng)
                        if school and self._is_quality_jiu_jitsu_school(school):
                            all_schools.append(school)
                            
                except Exception as e:
                    print(f"      ‚ö†Ô∏è Search failed for {keyword}: {str(e)[:30]}...")
                    continue
        
        return all_schools
    
    def _extract_detailed_school_info(self, place: Dict, center_lat: float, center_lng: float) -> Optional[JiuJitsuSchool]:
        """Extract detailed school information with distance calculation"""
        try:
            place_id = place.get('place_id')
            
            # Get detailed information
            if place_id:
                try:
                    details = self.google_client.place(
                        place_id=place_id,
                        fields=[
                            'name', 'formatted_address', 'rating', 'user_ratings_total',
                            'formatted_phone_number', 'website', 'price_level', 'opening_hours',
                            'geometry', 'types'
                        ]
                    )['result']
                    place.update(details)
                except Exception as e:
                    print(f"      ‚ö†Ô∏è Failed to get details for {place.get('name', 'Unknown')}")
            
            name = place.get('name', 'Unknown')
            if not name or name == 'Unknown':
                return None
            
            # Calculate distance
            distance_miles = None
            geometry = place.get('geometry', {})
            if geometry and geometry.get('location'):
                place_lat = geometry['location']['lat']
                place_lng = geometry['location']['lng']
                distance_miles = self._calculate_distance(center_lat, center_lng, place_lat, place_lng)
            
            # Check if currently open
            is_open = None
            opening_hours = place.get('opening_hours')
            if opening_hours:
                is_open = opening_hours.get('open_now')
            
            return JiuJitsuSchool(
                name=name,
                address=place.get('formatted_address', place.get('vicinity', 'Address not available')),
                rating=place.get('rating', 0),
                total_ratings=place.get('user_ratings_total', 0),
                phone=place.get('formatted_phone_number'),
                website=place.get('website'),
                price_level=place.get('price_level'),
                distance_miles=distance_miles,
                place_id=place_id or "",
                is_open=is_open,
                place_types=place.get('types', [])
            )
            
        except Exception as e:
            return None
    
    def _search_fallback_by_zipcode(self, zipcode: str, min_rating: float, max_rating: float) -> List[JiuJitsuSchool]:
        """Search curated database by zip code"""
        schools = []
        
        # Direct zip code match
        if zipcode in self.zipcode_schools:
            for school_data in self.zipcode_schools[zipcode]:
                if min_rating <= school_data["rating"] <= max_rating:
                    school = JiuJitsuSchool(
                        name=school_data["name"],
                        address=school_data["address"],
                        rating=school_data["rating"],
                        total_ratings=50,  # Estimated
                        phone=school_data.get("phone"),
                        distance_miles=1.0  # Estimated for zip code area
                    )
                    schools.append(school)
        
        # Look in nearby zip codes if no results
        if not schools:
            nearby_zips = self._get_nearby_zipcodes(zipcode)
            for nearby_zip in nearby_zips:
                if nearby_zip in self.zipcode_schools:
                    for school_data in self.zipcode_schools[nearby_zip]:
                        if min_rating <= school_data["rating"] <= max_rating:
                            school = JiuJitsuSchool(
                                name=school_data["name"],
                                address=school_data["address"],
                                rating=school_data["rating"],
                                total_ratings=50,
                                phone=school_data.get("phone"),
                                distance_miles=2.5  # Estimated for nearby zip
                            )
                            schools.append(school)
        
        return schools
    
    def _is_quality_jiu_jitsu_school(self, school: JiuJitsuSchool) -> bool:
        """Check if this is likely a quality jiu jitsu school"""
        name_lower = school.name.lower()
        
        # Strong jiu jitsu indicators
        jiu_jitsu_keywords = [
            'jiu jitsu', 'jiu-jitsu', 'jiujitsu', 'bjj', 'brazilian jiu jitsu',
            'gracie', 'martial arts academy', 'martial arts', 'mma'
        ]
        
        # Check name
        has_jjj_keyword = any(keyword in name_lower for keyword in jiu_jitsu_keywords)
        
        # Check place types
        place_types = school.place_types or []
        has_gym_type = any(ptype in ['gym', 'health', 'establishment'] for ptype in place_types)
        
        # Exclude obvious non-martial arts places
        exclude_keywords = ['restaurant', 'store', 'shop', 'hospital', 'clinic']
        is_excluded = any(keyword in name_lower for keyword in exclude_keywords)
        
        return has_jjj_keyword and has_gym_type and not is_excluded
    
    def _filter_and_sort_schools(self, schools: List[JiuJitsuSchool], min_rating: float, 
                                max_rating: float, limit: int) -> List[JiuJitsuSchool]:
        """Filter schools by rating range and sort by quality metrics"""
        # Filter by rating range
        filtered = [s for s in schools if min_rating <= s.rating <= max_rating]
        
        # Remove duplicates based on name similarity
        unique_schools = []
        seen_names = set()
        
        for school in filtered:
            normalized_name = school.name.lower().replace(' ', '').replace('-', '')
            if normalized_name not in seen_names:
                seen_names.add(normalized_name)
                unique_schools.append(school)
        
        # Sort by: rating (desc), total_ratings (desc), distance (asc)
        unique_schools.sort(key=lambda x: (
            -x.rating,  # Higher rating first
            -(x.total_ratings or 0),  # More reviews first
            x.distance_miles or 999  # Closer first
        ))
        
        return unique_schools[:limit]
    
    def _calculate_distance(self, lat1: float, lng1: float, lat2: float, lng2: float) -> float:
        """Calculate distance in miles between two coordinates"""
        import math
        
        # Haversine formula
        R = 3959  # Earth's radius in miles
        lat1_rad = math.radians(lat1)
        lat2_rad = math.radians(lat2)
        delta_lat = math.radians(lat2 - lat1)
        delta_lng = math.radians(lng2 - lng1)
        
        a = (math.sin(delta_lat/2) ** 2 + 
             math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(delta_lng/2) ** 2)
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
        
        return R * c
    
    def _get_nearby_zipcodes(self, zipcode: str) -> List[str]:
        """Get nearby zip codes (simplified mapping)"""
        nearby_map = {
            "92120": ["92101", "92126", "92130"],
            "92101": ["92120", "92109", "92117"],
            "92126": ["92120", "92130", "92131"],
            "78701": ["78728"],
            "90210": ["90211", "90212"],
            "10001": ["10010", "10011"]
        }
        return nearby_map.get(zipcode, [])
    
    def _suggest_nearby_zipcodes(self, zipcode: str) -> List[str]:
        """Suggest nearby zip codes that have schools"""
        nearby = self._get_nearby_zipcodes(zipcode)
        available = [zip_code for zip_code in nearby if zip_code in self.zipcode_schools]
        return available[:3]


def display_results(schools: List[JiuJitsuSchool], zipcode: str, min_rating: float, max_rating: float):
    """Display search results with detailed formatting"""
    if not schools:
        print(f"\n‚ùå No jiu jitsu schools found in ZIP {zipcode} with {min_rating}-{max_rating} star rating.")
        return
    
    print(f"\nüéØ Jiu Jitsu Schools in ZIP {zipcode} ({min_rating}-{max_rating}‚≠ê):")
    print("=" * 90)
    
    for i, school in enumerate(schools, 1):
        print(f"\n{i}. {school.name}")
        print(f"   ‚≠ê Rating: {school.rating}/5.0", end="")
        if school.total_ratings:
            print(f" ({school.total_ratings:,} reviews)")
        else:
            print()
        
        print(f"   üìç Address: {school.address}")
        
        if school.distance_miles:
            print(f"   üìè Distance: {school.distance_miles:.1f} miles from ZIP center")
        
        if school.phone:
            print(f"   üìû Phone: {school.phone}")
        
        if school.website:
            print(f"   üåê Website: {school.website}")
        
        if school.price_level is not None:
            price_symbols = "$" * (school.price_level + 1)
            print(f"   üí∞ Price Level: {price_symbols} ({school.price_level + 1}/4)")
        
        if school.is_open is not None:
            status = "üü¢ Open Now" if school.is_open else "üî¥ Closed"
            print(f"   üïí Status: {status}")
        
        print("-" * 70)


def main():
    """Main function"""
    parser = argparse.ArgumentParser(
        description="Precision Jiu Jitsu Finder by ZIP Code with adjustable rating filters",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Basic search
  python jiu_jitsu_zipcode.py --zip 92120 --api-key YOUR_KEY
  
  # High-rated schools only
  python jiu_jitsu_zipcode.py --zip 92120 --min-rating 4.0 --api-key YOUR_KEY
  
  # Specific rating range
  python jiu_jitsu_zipcode.py --zip 92120 --min-rating 3.5 --max-rating 4.5 --api-key YOUR_KEY
  
  # Adjust search radius
  python jiu_jitsu_zipcode.py --zip 92120 --radius 5000 --limit 20 --api-key YOUR_KEY
  
  # Works without API key too (limited results)
  python jiu_jitsu_zipcode.py --zip 92120 --min-rating 4.0

Available ZIP codes with data: 92120, 92101, 92126, 92130, 92109, 92117, 78701, 78728, 90210, 10001
        """
    )
    
    parser.add_argument('--zip', required=True, help='ZIP code to search in')
    parser.add_argument('--api-key', help='Google Places API key (optional)')
    parser.add_argument('--min-rating', type=float, default=3.0, help='Minimum rating (default: 3.0)')
    parser.add_argument('--max-rating', type=float, default=5.0, help='Maximum rating (default: 5.0)')
    parser.add_argument('--radius', type=int, default=3000, help='Search radius in meters (default: 3000)')
    parser.add_argument('--limit', type=int, default=15, help='Maximum results (default: 15)')
    parser.add_argument('--save', help='Save results to JSON file')
    
    args = parser.parse_args()
    
    # Validate inputs
    if not (0 <= args.min_rating <= 5) or not (0 <= args.max_rating <= 5):
        print("‚ùå Error: Ratings must be between 0 and 5")
        sys.exit(1)
    
    if args.min_rating > args.max_rating:
        print("‚ùå Error: Minimum rating cannot be higher than maximum rating")
        sys.exit(1)
    
    # Get API key from env if not provided
    api_key = args.api_key or os.getenv('GOOGLE_PLACES_API_KEY')
    
    try:
        # Initialize finder
        finder = ZipCodeJiuJitsuFinder(api_key)
        
        # Search for schools
        schools = finder.search_by_zipcode(
            zipcode=args.zip,
            min_rating=args.min_rating,
            max_rating=args.max_rating,
            radius=args.radius,
            limit=args.limit
        )
        
        # Display results
        display_results(schools, args.zip, args.min_rating, args.max_rating)
        
        # Save results if requested
        if args.save and schools:
            schools_data = []
            for school in schools:
                school_dict = {
                    'name': school.name,
                    'address': school.address,
                    'rating': school.rating,
                    'total_ratings': school.total_ratings,
                    'phone': school.phone,
                    'website': school.website,
                    'price_level': school.price_level,
                    'distance_miles': school.distance_miles,
                    'place_id': school.place_id,
                    'is_open': school.is_open
                }
                schools_data.append(school_dict)
            
            with open(args.save, 'w', encoding='utf-8') as f:
                json.dump(schools_data, f, indent=2, ensure_ascii=False)
            
            print(f"üíæ Results saved to: {args.save}")
        
        # Print summary
        if schools:
            avg_rating = sum(s.rating for s in schools) / len(schools)
            total_reviews = sum(s.total_ratings or 0 for s in schools)
            
            print(f"\nüìä Search Summary:")
            print(f"   üéØ ZIP Code: {args.zip}")
            print(f"   ‚≠ê Rating Range: {args.min_rating} - {args.max_rating}")
            print(f"   üè´ Schools Found: {len(schools)}")
            print(f"   üìä Average Rating: {avg_rating:.1f}/5.0")
            if total_reviews:
                print(f"   üí¨ Total Reviews: {total_reviews:,}")
            print(f"   üèÜ Best: {schools[0].name} ({schools[0].rating}/5.0)")
        
    except Exception as e:
        print(f"‚ùå Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
